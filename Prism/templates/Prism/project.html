{% extends "Prism/layout.html" %}

{% block title %}
Pri2m : {{ project.projectnumber }}
{% endblock %}

{% block content %}
<h1>{{ project.projectnumber }} - {{ project.projectname }}</h1>

{% if custom_errors %}
<ul>
    {% for error in custom_errors %}
        <li class="form-custom-error">{{error}}</li>
    {% endfor %}
</ul>
{% endif %}

{% if form.non_field_errors %}
<ul>
    {% for error in form.non_field_errors %}
        <li class="form-error">{{error}}</li>
    {% endfor %}
</ul>
{% endif %}
{% if dat_allocation_form.non_field_errors %}
<ul>
    {% for error in dat_allocation_form.non_field_errors %}
        <li class="form-error">{{error}}</li>
    {% endfor %}
</ul>
{% endif %}
{% if p_kristal_form.non_field_errors %}
<ul>
    {% for error in p_kristal_form.non_field_errors %}
        <li class="form-error">{{error}}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <form action="" method = "POST">
                {% csrf_token %}
                <p><input class="btn btn-primary" type="submit" value="Submit"></p>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-auto">
                            
                            <fieldset>
                                <legend>Project Details</legend>
                                <p>
                                    <label for="project-select">Project Number</label>
                                    <select id="project-select" class="select"> 
                                        {% for project_number in project_numbers %} 
                                        <option value="{% url 'project' project_number.projectnumber %}" 
                                                {% if project_number.projectnumber == project.projectnumber %}selected{% endif %}> 
                                            {{ project_number.projectnumber }} 
                                        </option> 
                                        {% endfor %} 
                                    </select> 
                                    <script> 
                                        document.getElementById("project-select").addEventListener("change", function () { window.location.href = this.value; }); 
                                    </script>
                                </p>
                                <p>{{ form.projectname.as_field_group }}</p>
                                <p>{{ form.stage_id.as_field_group }}</p>
                                <p>{{ form.classification_id.as_field_group }}</p>
                            </fieldset>
                            
                        </div>
                        <div class="col-md-auto">
                            
                            <fieldset>
                                <legend>Key Dates</legend>
                                <p>{{ form.projectedstartdate.as_field_group }}</p>
                                <p>{{ form.projectedenddate.as_field_group }}</p>
                                <p>{{ form.startdate.as_field_group }}</p>
                                <p>{{ form.enddate.as_field_group }}</p>
                            </fieldset>

                        </div>
                        <div class="col-md-auto">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-auto">
                                        
                                        <fieldset>
                                            <legend>Ownership</legend>
                                            <p>{{ form.pi.as_field_group }}</p>
                                            <p>{{ form.leadapplicant.as_field_group }}</p>
                                            <p>{{ form.faculty_id.as_field_group }}</p>
                                        </fieldset>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-auto">
                                        
                                        <fieldset>
                                            <legend>Type</legend>
                                            <p>{{ form.lida.as_field_group }}</p>
                                            <p>{{ form.internship.as_field_group }}</p>
                                        </fieldset>

                                    </div>
                                    <div class="col-md-auto">
                                        
                                        <fieldset>
                                            <legend>Compliance</legend>
                                            <p>{{ form.dspt.as_field_group }}</p>
                                            <p>{{ form.iso27001.as_field_group }}</p>
                                        </fieldset>        

                                    </div>
                                    <div class="col-md-auto">
                                        
                                        <fieldset>
                                            <legend>Platform</legend>
                                            <p>{{ form.laser.as_field_group }}</p>
                                            <p>{{ form.irc.as_field_group }}</p>
                                            <p>{{ form.seed.as_field_group }}</p>
                                        </fieldset>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-auto">
                            <legend>Project Documents</legend> 
                            <div class="ml-auto">
                                <div class="btn-group-vertical">
                                    
                                    {% for doc, detail in p_docs.items %}
                                        {% if detail.status == "accepted" %}
                                            <button type="button" class="btn btn-success" onclick=location.href="/project/{{ project.projectnumber }}/docs/{{ detail.url }}">{{ doc }}</button>
                                        {% elif detail.status == "present" %}
                                            <button type="button" class="btn btn-warning" onclick=location.href="/project/{{ project.projectnumber }}/docs/{{ detail.url }}">{{ doc }}</button>
                                        {% else %}
                                            <button type="button" class="btn btn-danger" onclick=location.href="/project/{{ project.projectnumber }}/docs/{{ detail.url }}">{{ doc }}</button>
                                        {% endif %}
                                    {% endfor %}
                                    <button type="button" class="btn btn-secondary">User Docs</button>
                                    <button type="button" class="btn btn-secondary" onclick=location.href="/project/{{ project.projectnumber }}/docs">Project Docs</button>

                                </div>
                            </div>

                            <fieldset>
                                {{ form.pid }}
                                {{ form.validfrom }}
                                {{ form.validto }}
                                {{ form.createdby }}
                            </fieldset>
                        </div>
            </form>
                        <div class="col-md-auto">
                            <legend>DAT Allocation</legend>
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">From</th>
                                        <th scope="col">To</th>
                                        <th scope="col">FTE %</th>
                                        <th scope="col">Account</th>
                                        <th scope="col"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in dat_allocation %}
                                        <tr>
                                            <td style="white-space: nowrap;">{{ item.fromdate | date:"Y-m-d" }}</td>
                                            <td style="white-space: nowrap;">{{ item.todate | date:"Y-m-d" }}</td>
                                            <td>{{ item.fte }}</td>
                                            <td>{{ item.account }}</td>
                                            <td><a href='/project/{{ project.projectnumber }}/remove/datallocation/{{item.projectdatallocationid}}'>x</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="accordion" id="accordionDatAllocation">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingDatAllocation">
                                        <button class="accordion-button {% if not dat_allocation_form.non_field_errors %} collapsed {% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDatAllocation" aria-expanded="false" aria-controls="collapseDatAllocation">
                                            New DAT Allocation
                                        </button>
                                    </h2>
                                    <div id="collapseDatAllocation" class="accordion-collapse collapse {% if dat_allocation_form.non_field_errors %} show {% endif %}" aria-labelledby="headingDatAllocation" data-bs-parent="#accordionDatAllocation">
                                        <div class="accordion-body">
                                            <form action="" method="POST">
                                                {% csrf_token %}
                                                {{ dat_allocation_form.as_p }}
                                                <input class="btn btn-primary" type="submit" value="Add DAT Allocation">
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <legend style="text-align: left;">Platform</legend> 
                        <div class="accordion" id="accordionPlatform">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingPlatform">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlatform" aria-expanded="false" aria-controls="collapsePlatform">
                                        Platform Details
                                    </button>
                                </h2>
                                <div id="collapsePlatform" class="accordion-collapse collapse" aria-labelledby="headingPlatform" data-bs-parent="#accordionPlatform">
                                    <div class="accordion-body">
                                        <form action="" method="POST">
                                            {% csrf_token %}
                                            <fieldset>
                                                <div class="input-group">
                                                    {{ platform_form.platforminfoid }}
                                                    {{ platform_form.projectplatforminfo }}
                                                    <input class="btn btn-primary" type="submit" value="Add platform item">
                                                </div>
                                            </fieldset>
                                        </form>
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Item</th>
                                                    <th scope="col">Description</th>
                                                    <th scope="col"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in platforminfo %}
                                                    <tr>
                                                        <td>{{ item.platforminfoid__platforminfodescription }}</td>
                                                        <td>{{ item.projectplatforminfo }}</td>
                                                        <td><a href='/project/{{ project.projectnumber }}/remove/platform/{{ item.projectplatforminfoid }}'>x</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">

                        <legend>Membership</legend>
                        <form action="" method="POST">
                            {% csrf_token %}
                            <fieldset>
                                <div class="input-group">
                                    {{ p_user_form.usernumber }}
                                    {{ p_user_form.projectnumber.as_hidden }}
                                    <input class="btn btn-primary" type="submit" value="Add member">
                                </div>
                            </fieldset>
                        </form>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Full name</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in members %}
                                <tr>
                                    <td><a href='/user/{{ member.usernumber }}'>{{ member.firstname }} {{ member.lastname }}</a></td>
                                    <td><a href='/remove/userproject/{{ member.userprojectid }}'>x</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <legend>Grant</legend> 
                        <form action="" method="POST">
                            {% csrf_token %}
                            <fieldset>
                                <div class="input-group">
                                    {{ p_kristal_form.kristalref }}
                                    <input class="btn btn-primary" type="submit" value="Add grant">
                                </div>
                            </fieldset>
                        </form>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Kristal Ref</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grant in grants %}
                                    <tr>
                                        <td>{{ grant.kristalref }}</td>
                                        <td><a href='/remove/projectkristal/{{ grant.projectkristalid }}'>x</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
            
        <div class="col-md-6">
            <div class="container-fluid">
                {% if notes_filter %}
                    <legend>Notes containing "{{ notes_filter }}" (<a href='/project/{{ project.projectnumber }}'>clear</a>)</legend>
                {% else %}
                    <legend>Notes</legend> 
                {% endif %}
                
                <div class="row">
                    <div class="col-md-8">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <fieldset>
                                <div class="input-group">
                                    {{ new_note.pnote }}
                                    <input class="btn btn-primary" type="submit" value="Add note">
                                </div>
                            </fieldset>
                            <fieldset>
                                {{ new_note.pnid }}
                                {{ new_note.projectnumber }}
                                {{ new_note.created }}
                                {{ new_note.createdby }}
                            </fieldset>
                        </form>
                    </div>

                    <div class="col-md-4">
                        <form action="" method="get">
                            <div class="input-group">
                                <input name="search_notes" type="text" class="form-control" placeholder="Search...">
                                <button class="btn btn-primary" type="submit" id="button-search">Search</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                <th scope="col">Note</th>
                                <th style="white-space: nowrap;" scope="col">Created</th>
                                <th style="white-space: nowrap;" scope="col">Created By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for note in notes.object_list %}
                                    <tr>
                                        <td>{{ note.pnote }}</td>
                                        <td style="white-space: nowrap;">{{ note.created | date:"Y-m-d" }}</td>
                                        <td style="white-space: nowrap;">{{ note.createdby }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="pagination">
                            <ul class="pagination pagination-sm">
                            {% if notes.has_previous %}
                                <li class="page-item">
                                    {% if notes_filter %}
                                        <a class="page-link" href="?search_notes={{ notes_filter }}&page={{ notes.previous_page_number }}">&laquo;</a>
                                    {% else %}
                                        <a class="page-link" href="?page={{ notes.previous_page_number }}">&laquo;</a>
                                    {% endif %}
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">&laquo;</a>
                                </li>
                            {% endif %}
    
                            {% for num in notes.paginator.page_range %}
                                {% if notes.number == num %}
                                    <li class="page-item active">
                                        {% if notes_filter %}
                                            <a class="page-link" href="?search_notes={{ notes_filter }}&page={{ num }}">{{ num }}</a>
                                        {% else %}
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        {% endif %}
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        {% if notes_filter %}
                                            <a class="page-link" href="?search_notes={{ notes_filter }}&page={{ num }}">{{ num }}</a>
                                        {% else %}
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        {% endif %}
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if notes.has_next %}
                                <li class="page-item">
                                    {% if notes_filter %}
                                        <a class="page-link" href="?search_notes={{ notes_filter }}&page={{ notes.next_page_number }}">&raquo;</a>
                                    {% else %}
                                        <a class="page-link" href="?page={{ notes.next_page_number }}">&raquo;</a>
                                    {% endif %}
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">&raquo;</a>
                                </li>
                            {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

    </div>
</div>

{% endblock %}